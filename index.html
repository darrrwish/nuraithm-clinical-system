<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التسليم السريري الذكي - Nuraithm</title>
    
    <!-- تيندواند CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- خطوط جوجل -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- أيقونات Material -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    
    <!-- مكتبات JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- إضافة PocketBase -->
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#434E78',
                        secondary: '#607B8F',
                        accent: {
                            yellow: '#F7E396',
                            orange: '#E97F4A',
                        }
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
        
        // تهيئة PocketBase
        window.PB = new PocketBase('https://pb.ahmeddarwish.info');
        
        // مفتاح API للذكاء الاصطناعي
        window.DEEPSEEK_API_KEY = localStorage.getItem('nuraithm_deepseek_key') || null;
        
        // كود بديل لتأكد تحميل مكتبات PDF
        window.ensurePDFLoaded = function() {
            return new Promise((resolve) => {
                if (typeof jspdf !== 'undefined') {
                    resolve();
                } else {
                    // إعادة محاولة تحميل مكتبات PDF
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = function() {
                        const script2 = document.createElement('script');
                        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';
                        script2.onload = resolve;
                        document.head.appendChild(script2);
                    };
                    document.head.appendChild(script);
                }
            });
        };
    </script>
    
    <style>
        body { 
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
            transition: background-color 0.3s ease;
        }
        .dark body {
            background-color: #020617;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(67, 78, 120, 0.1);
        }
        .dark .glass-card {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* تأثيرات CSS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-in {
            animation: fadeIn 0.3s ease-out;
        }
        .slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }
        
        /* إصلاح اختيار النص */
        .selectable {
            user-select: text;
            -webkit-user-select: text;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 transition-colors duration-300">
    <div id="app" class="min-h-screen"></div>
    
    <!-- نافذة تسجيل الدخول -->
      <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-md w-full">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-primary text-3xl">medical_services</span>
                    </div>
                    <h3 class="text-xl font-black text-slate-900 dark:text-white mb-2" id="auth-title">تسجيل الدخول</h3>
                    <p class="text-slate-600 dark:text-slate-400 text-sm" id="auth-subtitle">
                        أدخل بيانات الدخول للمتابعة
                    </p>
                </div>
                
                <div id="auth-form" class="space-y-4">
                    <!-- Login Form -->
                    <div id="login-form">
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                اسم المستخدم أو البريد الإلكتروني
                            </label>
                            <input type="text" id="login-identity" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أدخل اسم المستخدم أو البريد الإلكتروني">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                كلمة المرور
                            </label>
                            <input type="password" id="login-password" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أدخل كلمة المرور">
                        </div>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="register-form" class="hidden">
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                الاسم الكامل
                            </label>
                            <input type="text" id="register-name" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أدخل اسمك الكامل">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                اسم المستخدم
                            </label>
                            <input type="text" id="register-username" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أدخل اسم المستخدم">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                البريد الإلكتروني
                            </label>
                            <input type="email" id="register-email" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أدخل البريد الإلكتروني">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                كلمة المرور
                            </label>
                            <input type="password" id="register-password" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="كلمة مرور قوية (8 أحرف على الأقل)">
                        </div>
                        <div>
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                                تأكيد كلمة المرور
                            </label>
                            <input type="password" id="register-password-confirm" 
                                class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                                placeholder="أعد إدخال كلمة المرور">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-6 mb-4">
                    <button onclick="toggleAuthForm()" class="text-primary text-sm font-bold hover:underline" id="toggle-auth">
                        إنشاء حساب جديد
                    </button>
                    <button onclick="demoLogin()" class="text-slate-500 text-sm font-bold hover:text-primary">
                        دخول تجريبي
                    </button>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="hideAuthModal()" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl font-bold hover:bg-slate-200 transition-all">
                        إلغاء
                    </button>
                    <button onclick="handleAuth()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-primary/90 transition-all" id="auth-action">
                        تسجيل الدخول
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة إعدادات API -->
    <div id="api-key-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-md w-full">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-primary text-3xl">auto_awesome</span>
                    </div>
                    <h3 class="text-xl font-black text-slate-900 dark:text-white mb-2">تفعيل الذكاء الاصطناعي</h3>
                    <p class="text-slate-600 dark:text-slate-400 text-sm">
                        أدخل مفتاح DeepSeek API لتفعيل الميزات الذكية
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest mb-2 block">
                            مفتاح DeepSeek API
                        </label>
                        <input type="password" id="api-key-input" 
                            class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl text-sm font-bold outline-none focus:ring-2 ring-primary/20"
                            placeholder="أدخل مفتاح API الخاص بك...">
                    </div>
                    
                    <div class="text-xs text-slate-500 space-y-1">
                        <p>احصل على المفتاح من:</p>
                        <a href="https://platform.deepseek.com/api_keys" target="_blank" 
                           class="text-primary font-bold hover:underline inline-flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">open_in_new</span>
                            DeepSeek Platform
                        </a>
                        <p class="text-[10px] mt-2">(مفتاح تجريبي مجاني متاح - سجل واحصل على رصيد مجاني)</p>
                    </div>
                    
                    <!-- زر اختبار الاتصال -->
                    <div id="api-test-result" class="hidden p-3 rounded-xl text-sm"></div>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button onclick="testApiConnection()" class="px-4 py-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl font-bold hover:bg-blue-200 transition-all">
                        اختبار الاتصال
                    </button>
                    <button onclick="saveApiKey()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-primary/90 transition-all">
                        حفظ والمتابعة
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- ملفات JavaScript -->
<script src="utils.js"></script>
<script src="pocketbase-service.js"></script>
<script src="deepseek-service.js"></script>
<script src="pdf-export.js"></script>
<script src="app.js"></script>
    
    <script>
        // وظائف نافذة تسجيل الدخول
        let isRegisterMode = false;
        
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
        }
        
        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }
        
    function toggleAuthForm() {
            isRegisterMode = !isRegisterMode;
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const authAction = document.getElementById('auth-action');
            const toggleAuth = document.getElementById('toggle-auth');
            
            if (isRegisterMode) {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'إنشاء حساب جديد';
                authSubtitle.textContent = 'أنشئ حسابك للبدء في استخدام النظام';
                authAction.textContent = 'إنشاء الحساب';
                toggleAuth.textContent = 'تسجيل الدخول';
            } else {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.textContent = 'تسجيل الدخول';
                authSubtitle.textContent = 'أدخل بيانات الدخول للمتابعة';
                authAction.textContent = 'تسجيل الدخول';
                toggleAuth.textContent = 'إنشاء حساب جديد';
            }
        }
        
        async function handleAuth() {
            if (isRegisterMode) {
                // Register
                const name = document.getElementById('register-name').value.trim();
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                
                if (!name || !username || !password) {
                    alert('الرجاء ملء جميع الحقول المطلوبة');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    alert('كلمتا المرور غير متطابقتين');
                    return;
                }
                
                if (password.length < 8) {
                    alert('كلمة المرور يجب أن تكون 8 أحرف على الأقل');
                    return;
                }
                
                try {
                    const userData = {
                        username: username,
                        password: password,
                        passwordConfirm: passwordConfirm,
                        name: name,
                        email: email || ''
                    };
                    
                    const user = await PB.collection('users').create(userData);
                    await PB.collection('users').authWithPassword(username, password);
                    
                    hideAuthModal();
                    if (window.NuraithmApp) {
                        window.NuraithmApp.state.isAuthenticated = true;
                        window.NuraithmApp.state.currentUser = user;
                        window.NuraithmApp.init();
                    }
                    
                } catch (error) {
                    console.error('Registration error:', error);
                    alert('خطأ في التسجيل: ' + (error.message || 'يرجى المحاولة مرة أخرى'));
                }
                
            } else {
                // Login
                const identity = document.getElementById('login-identity').value.trim();
                const password = document.getElementById('login-password').value;
                
                if (!identity || !password) {
                    alert('الرجاء إدخال اسم المستخدم وكلمة المرور');
                    return;
                }
                
                try {
                    await PB.collection('users').authWithPassword(identity, password);
                    
                    hideAuthModal();
                    if (window.NuraithmApp) {
                        window.NuraithmApp.state.isAuthenticated = true;
                        window.NuraithmApp.state.currentUser = PB.authStore.model;
                        window.NuraithmApp.init();
                    }
                    
                } catch (error) {
                    console.error('Login error:', error);
                    alert('خطأ في الدخول: ' + (error.message || 'يرجى التحقق من البيانات والمحاولة مرة أخرى'));
                }
            }
        }
        async function demoLogin() {
            try {
                await PB.collection('users').authWithPassword('demodar', 'demodar');
                
                hideAuthModal();
                if (window.NuraithmApp) {
                    window.NuraithmApp.state.isAuthenticated = true;
                    window.NuraithmApp.state.currentUser = PB.authStore.model;
                    window.NuraithmApp.init();
                }
                
            } catch (error) {
                console.error('Demo login error:', error);
                alert('خطأ في الدخول التجريبي. يرجى المحاولة يدوياً.');
            }
        }
        
        // وظائف نافذة API
        function showApiKeyModal() {
            document.getElementById('api-key-modal').classList.remove('hidden');
            document.getElementById('api-key-input').value = window.DEEPSEEK_API_KEY || '';
        }
        
        function hideApiKeyModal() {
            document.getElementById('api-key-modal').classList.add('hidden');
        }
        
        async function testApiConnection() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) {
                alert('يرجى إدخال مفتاح API أولاً');
                return;
            }
            
            // اختبار مؤقت
            const testResult = document.getElementById('api-test-result');
            testResult.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined animate-spin">sync</span>
                    <span>جاري اختبار الاتصال...</span>
                </div>
            `;
            testResult.className = 'p-3 rounded-xl text-sm bg-blue-50 dark:bg-blue-900/30';
            testResult.classList.remove('hidden');
            
            try {
                // استخدام خدمة DeepSeek للاختبار
                const testService = window.DeepSeekService || {
                    testConnection: async () => {
                        // اختبار مباشر للـ API
                        const response = await fetch('https://api.deepseek.com/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'deepseek-chat',
                                messages: [{ role: 'user', content: 'Hello' }],
                                max_tokens: 10
                            })
                        });
                        
                        return {
                            success: response.ok,
                            message: response.ok ? 'API connection successful' : `API error: ${response.status}`
                        };
                    }
                };
                
                const result = await testService.testConnection();
                
                if (result.success) {
                    testResult.innerHTML = `
                        <div class="flex items-center gap-2 text-green-600">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>✓ اتصال ناجح! المفتاح صالح.</span>
                        </div>
                    `;
                    testResult.className = 'p-3 rounded-xl text-sm bg-green-50 dark:bg-green-900/30';
                } else {
                    testResult.innerHTML = `
                        <div class="flex items-center gap-2 text-red-600">
                            <span class="material-symbols-outlined">error</span>
                            <span>✗ فشل الاتصال: ${result.message}</span>
                        </div>
                    `;
                    testResult.className = 'p-3 rounded-xl text-sm bg-red-50 dark:bg-red-900/30';
                }
            } catch (error) {
                testResult.innerHTML = `
                    <div class="flex items-center gap-2 text-red-600">
                        <span class="material-symbols-outlined">error</span>
                        <span>✗ خطأ في الاتصال: ${error.message}</span>
                    </div>
                `;
                testResult.className = 'p-3 rounded-xl text-sm bg-red-50 dark:bg-red-900/30';
            }
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                window.DEEPSEEK_API_KEY = apiKey;
                localStorage.setItem('nuraithm_deepseek_key', apiKey);
                
                // تحديث الخدمة
                if (window.DeepSeekService) {
                    window.DeepSeekService.updateApiKey(apiKey);
                }
                
                hideApiKeyModal();
                
                // إظهار رسالة نجاح
                if (window.NuraithmApp) {
                    window.NuraithmApp.showNotification(
                        window.NuraithmApp.state.lang === 'ar' 
                            ? 'تم تفعيل الذكاء الاصطناعي بنجاح!' 
                            : 'AI features activated successfully!',
                        'success'
                    );
                    
                    // تحديث حالة التطبيق
                    window.NuraithmApp.state.apiKeyConfigured = true;
                    window.NuraithmApp.render();
                }
                
            } else {
                alert('يرجى إدخال مفتاح API صالح');
            }
        }
        
        function skipApiKey() {
            hideApiKeyModal();
            if (window.NuraithmApp) {
                window.NuraithmApp.state.apiKeyConfigured = false;
            }
        }
        
        // التحقق من المصادقة عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من اتصال PocketBase
            if (PB.authStore.isValid) {
                if (window.NuraithmApp) {
                    window.NuraithmApp.state.isAuthenticated = true;
                    window.NuraithmApp.state.currentUser = PB.authStore.model;
                    window.NuraithmApp.init();
                }
            } else {
                // إظهار نافذة تسجيل الدخول بعد تأخير
                setTimeout(() => {
                    showAuthModal();
                }, 500);
            }
            
            // إضافة تحميل مكتبات PDF عند الحاجة
            setTimeout(() => {
                if (typeof jspdf === 'undefined') {
                    console.log('jsPDF not loaded, attempting to load...');
                    window.ensurePDFLoaded().then(() => {
                        console.log('PDF libraries loaded successfully');
                    });
                }
            }, 1000);
        });
        
        // وظائف مساعدة للـ PDF
        window.exportPDF = async function(patient) {
            try {
                await window.ensurePDFLoaded();
                
                if (window.PDFExport && window.PDFExport.exportHandoverPDF) {
                    const signature = window.NuraithmApp?.state?.signature || 'Nurse. Ahmed Khaled';
                    const result = window.PDFExport.exportHandoverPDF(patient, signature);
                    
                    if (result && result.success) {
                        if (window.NuraithmApp) {
                            window.NuraithmApp.showNotification(
                                window.NuraithmApp.state.lang === 'ar' 
                                    ? 'تم تصدير PDF بنجاح' 
                                    : 'PDF exported successfully',
                                'success'
                            );
                        }
                    } else {
                        throw new Error(result?.error || 'Unknown error');
                    }
                } else {
                    throw new Error('PDF export service not available');
                }
            } catch (error) {
                console.error('Export error:', error);
                if (window.NuraithmApp) {
                    window.NuraithmApp.showNotification(
                        window.NuraithmApp.state.lang === 'ar' 
                            ? 'خطأ في تصدير PDF' 
                            : 'PDF export error',
                        'error'
                    );
                }
            }
        };
    </script>
</body>
</html>